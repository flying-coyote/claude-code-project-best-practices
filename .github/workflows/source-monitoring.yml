name: Source Monitoring

on:
  schedule:
    # Run every day at 9am UTC
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  check-anthropic-releases:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Get latest Claude Code release
        id: latest-release
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/anthropics/claude-code/releases/latest | jq -r '.tag_name')
          LATEST_URL=$(curl -s https://api.github.com/repos/anthropics/claude-code/releases/latest | jq -r '.html_url')
          LATEST_BODY=$(curl -s https://api.github.com/repos/anthropics/claude-code/releases/latest | jq -r '.body' | head -n 20)

          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "url=$LATEST_URL" >> $GITHUB_OUTPUT

          # Save body to file for issue creation
          echo "$LATEST_BODY" > release_notes.txt

      - name: Check if release is documented
        id: check-documented
        run: |
          # Check if version is mentioned in SOURCES.md
          if grep -q "${{ steps.latest-release.outputs.version }}" SOURCES.md; then
            echo "documented=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Release ${{ steps.latest-release.outputs.version }} is already documented"
          else
            echo "documented=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Release ${{ steps.latest-release.outputs.version }} is NOT documented"
          fi

      - name: Create issue for new release
        if: steps.check-documented.outputs.documented == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.latest-release.outputs.version }}';
            const url = '${{ steps.latest-release.outputs.url }}';
            const fs = require('fs');
            const releaseNotes = fs.readFileSync('release_notes.txt', 'utf8');

            const body = 'A new Claude Code release was detected: **' + version + '**\n\n' +
              '**Release URL**: ' + url + '\n\n' +
              '## Release Highlights\n' +
              releaseNotes + '\n\n' +
              '## Action Items\n' +
              '- [ ] Review release notes for new features/patterns\n' +
              '- [ ] Update SOURCES.md with new version reference\n' +
              '- [ ] Update relevant pattern files with new capabilities\n' +
              '- [ ] Check if any patterns need updates for breaking changes\n' +
              '- [ ] Update CHANGELOG references in SOURCES.md:74-89\n\n' +
              '**Automatically created by source-monitoring workflow**';

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üìö Review Claude Code ' + version + ' release',
              labels: ['documentation', 'source-update'],
              body: body
            });

            console.log('Created issue #' + issue.data.number);

  check-awesome-lists:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Check awesome-claude-code stars
        id: check-stars
        run: |
          # Check star count for hesreallyhim/awesome-claude-code
          CURRENT_STARS=$(curl -s https://api.github.com/repos/hesreallyhim/awesome-claude-code | jq -r '.stargazers_count // "unknown"')
          LAST_COMMIT=$(curl -s https://api.github.com/repos/hesreallyhim/awesome-claude-code/commits/main | jq -r '.commit.committer.date // "unknown"')

          echo "stars=$CURRENT_STARS" >> $GITHUB_OUTPUT
          echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT

          # Check if there were recent commits (last 7 days)
          WEEK_AGO=$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-7d +%Y-%m-%dT%H:%M:%SZ)

          if [[ "$LAST_COMMIT" != "unknown" && "$LAST_COMMIT" > "$WEEK_AGO" ]]; then
            echo "recent_update=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Recent updates detected in awesome-claude-code"
          else
            echo "recent_update=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No recent updates in awesome-claude-code"
          fi

      - name: Create issue for awesome list updates
        if: steps.check-stars.outputs.recent_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const stars = '${{ steps.check-stars.outputs.stars }}';
            const lastCommit = '${{ steps.check-stars.outputs.last_commit }}';

            const body = 'Recent activity detected in [hesreallyhim/awesome-claude-code](https://github.com/hesreallyhim/awesome-claude-code)\n\n' +
              '**Current stars**: ' + stars + '\n' +
              '**Last commit**: ' + lastCommit + '\n\n' +
              '## Action Items\n' +
              '- [ ] Review recent commits for new patterns/skills\n' +
              '- [ ] Check for new community best practices\n' +
              '- [ ] Validate new additions (‚úÖ Verified or üîç Discovered)\n' +
              '- [ ] Update SOURCES.md:1070-1089 verification status\n' +
              '- [ ] Consider incorporating high-value patterns\n\n' +
              '**Review Process**:\n' +
              '1. Visit the [repository](https://github.com/hesreallyhim/awesome-claude-code)\n' +
              '2. Check commits since last review\n' +
              '3. Evaluate relevance to this project\n' +
              '4. Document findings\n\n' +
              '**Automatically created by source-monitoring workflow**';

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîç Review awesome-claude-code updates',
              labels: ['documentation', 'source-update', 'community'],
              body: body
            });

            console.log('Created issue #' + issue.data.number);

  check-anthropic-blog:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Fetch Anthropic engineering blog RSS
        id: fetch-rss
        run: |
          # Fetch RSS feed (assuming it exists - adjust URL if needed)
          # For now, we'll check the engineering blog page
          LATEST_POST=$(curl -s https://www.anthropic.com/engineering | grep -o 'href="/engineering/[^"]*"' | head -1 | cut -d'"' -f2)

          if [ -n "$LATEST_POST" ]; then
            FULL_URL="https://www.anthropic.com${LATEST_POST}"
            echo "latest_url=$FULL_URL" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if blog post is documented
        if: steps.fetch-rss.outputs.found == 'true'
        id: check-blog
        run: |
          URL="${{ steps.fetch-rss.outputs.latest_url }}"

          if grep -q "$URL" SOURCES.md; then
            echo "documented=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Latest blog post is documented"
          else
            echo "documented=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Potential new blog post: $URL"
          fi

      - name: Create issue for new blog post
        if: steps.fetch-rss.outputs.found == 'true' && steps.check-blog.outputs.documented == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.fetch-rss.outputs.latest_url }}';

            const body = 'A potential new Anthropic Engineering blog post was detected.\n\n' +
              '**URL**: ' + url + '\n\n' +
              '## Action Items\n' +
              '- [ ] Read the blog post\n' +
              '- [ ] Determine if it contains new patterns\n' +
              '- [ ] Extract key insights and implementations\n' +
              '- [ ] Update relevant pattern files\n' +
              '- [ ] Add to SOURCES.md with proper attribution\n' +
              '- [ ] Update cross-references in related patterns\n\n' +
              '**Evidence Tier**: A (Primary source - Anthropic Engineering)\n\n' +
              '**Note**: This is a heuristic check. Verify the post is actually new and relevant.\n\n' +
              '**Automatically created by source-monitoring workflow**';

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üìö Review potential new Anthropic blog post',
              labels: ['documentation', 'source-update', 'tier-a'],
              body: body
            });

            console.log('Created issue #' + issue.data.number);

  check-practitioner-sources:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Check IndyDevDan activity
        id: check-indydevdan
        run: |
          # Check recent commits in disler's repositories
          REPOS=("single-file-agents" "indydevtools" "claude-code-hooks-multi-agent-observability")
          RECENT_ACTIVITY=false

          for repo in "${REPOS[@]}"; do
            LAST_COMMIT=$(curl -s "https://api.github.com/repos/disler/${repo}/commits?per_page=1" | jq -r 'if type == "array" then .[0].commit.committer.date // "unknown" else "unknown" end')
            WEEK_AGO=$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-7d +%Y-%m-%dT%H:%M:%SZ)

            if [[ "$LAST_COMMIT" != "unknown" && "$LAST_COMMIT" > "$WEEK_AGO" ]]; then
              echo "‚ö†Ô∏è Recent activity in disler/${repo}"
              RECENT_ACTIVITY=true
              break
            fi
          done

          if [ "$RECENT_ACTIVITY" = true ]; then
            echo "has_activity=true" >> $GITHUB_OUTPUT
          else
            echo "has_activity=false" >> $GITHUB_OUTPUT
          fi

      - name: Check framework updates
        id: check-frameworks
        run: |
          # Check GitHub Spec Kit and agentskills.io for updates
          FRAMEWORKS=(
            "github/spec-kit"
            "anthropics/skills"
          )

          UPDATES_FOUND=false

          for framework in "${FRAMEWORKS[@]}"; do
            LAST_COMMIT=$(curl -s "https://api.github.com/repos/${framework}/commits?per_page=1" | jq -r 'if type == "array" then .[0].commit.committer.date // "unknown" else "unknown" end')
            WEEK_AGO=$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-7d +%Y-%m-%dT%H:%M:%SZ)

            if [[ "$LAST_COMMIT" != "unknown" && "$LAST_COMMIT" > "$WEEK_AGO" ]]; then
              echo "‚ö†Ô∏è Recent activity in ${framework}"
              UPDATES_FOUND=true
            fi
          done

          if [ "$UPDATES_FOUND" = true ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Create daily review checklist
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toLocaleDateString('en-US', {
              month: 'long',
              day: 'numeric',
              year: 'numeric'
            });

            const hasPractitionerActivity = '${{ steps.check-indydevdan.outputs.has_activity }}' === 'true';
            const hasFrameworkUpdates = '${{ steps.check-frameworks.outputs.has_updates }}' === 'true';

            let body = 'Daily review checklist for ' + date + '\n\n';
            if (hasPractitionerActivity) body += 'üîî **Practitioner activity detected in last 7 days**\n';
            if (hasFrameworkUpdates) body += 'üîî **Framework updates detected in last 7 days**\n';
            body += '\n## Primary Sources (Tier A) - Checked Automatically\n' +
              '‚úÖ Anthropic releases monitored (see separate issues if new releases)\n' +
              '‚úÖ Awesome lists monitored (see separate issues if updates)\n' +
              '‚úÖ Blog monitoring active (see separate issues if new posts)\n\n' +
              '## Community Curated Lists (Daily Check)\n' +
              '- [ ] [hesreallyhim/awesome-claude-code](https://github.com/hesreallyhim/awesome-claude-code) - Check commits/stars\n' +
              '- [ ] [jqueryscript/awesome-claude-code](https://github.com/jqueryscript/awesome-claude-code)\n' +
              '- [ ] [josix/awesome-claude-md](https://github.com/josix/awesome-claude-md)\n' +
              '- [ ] [ccplugins/awesome-claude-code-plugins](https://github.com/ccplugins/awesome-claude-code-plugins)\n' +
              '- [ ] [travisvn/awesome-claude-skills](https://github.com/travisvn/awesome-claude-skills)\n\n' +
              '## Practitioner Content (Daily Check)\n' +
              '- [ ] [IndyDevDan YouTube](https://youtube.com/@IndyDevDan) - New videos/courses?\n' +
              '- [ ] [Aniket Panjwani X/Twitter](https://x.com/aniketapanjwani) - New tips/patterns?\n' +
              '- [ ] [Nate B. Jones Substack](https://natesnewsletter.substack.com) - New articles?\n' +
              '- [ ] [Daniel Miessler Fabric](https://github.com/danielmiessler/fabric) - New patterns?\n\n' +
              '## Standard Frameworks (Daily Check)\n' +
              '- [ ] [GitHub Spec Kit](https://github.com/github/spec-kit) - Check releases/commits\n' +
              '- [ ] [agentskills.io](https://agentskills.io/specification) - Spec updates?\n' +
              '- [ ] [BMAD Method](https://github.com/bmad-code-org/BMAD-METHOD) - New patterns?\n' +
              '- [ ] [OWASP MCP Top 10](https://owasp.org/www-project-mcp-top-10/) - Security updates?\n\n' +
              '## AI Coding Ecosystem (Daily Scan)\n' +
              '- [ ] Check [Aider releases](https://github.com/paul-gauthier/aider/releases)\n' +
              '- [ ] Check [Cursor updates](https://cursor.sh) (if major announcements)\n' +
              '- [ ] Scan Reddit: [r/ClaudeAI](https://reddit.com/r/ClaudeAI), [r/LocalLLaMA](https://reddit.com/r/LocalLLaMA)\n' +
              '- [ ] Check Hacker News: "Claude Code" OR "AI coding" mentions\n\n' +
              '## Documentation Maintenance (Daily)\n' +
              '- [ ] Review new issues created by automation\n' +
              '- [ ] Triage and prioritize pattern additions\n' +
              '- [ ] Update PLAN.md with completed items\n' +
              '- [ ] Check if any patterns need updates based on discoveries\n\n' +
              '## Verification Status (Update if Changed)\n' +
              '- [ ] Update SOURCES.md verification status (‚úÖ/üîç/‚ö†Ô∏è)\n' +
              '- [ ] Note any repositories that are now stale (>6 months)\n' +
              '- [ ] Add newly discovered resources\n\n' +
              '---\n\n' +
              '**Fast-Moving Sector Alert**: This space is evolving rapidly. Daily reviews ensure we don\'t miss important developments.\n\n' +
              '**Automatically created by source-monitoring workflow**';

            // Always create the daily checklist
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üìã Daily source review - ' + date,
              labels: ['documentation', 'daily-review'],
              body: body
            });

            console.log('Created issue #' + issue.data.number);

  self-compliance-audit:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Check for dogfooding gaps
        id: check-gaps
        run: |
          # Count entries in DOGFOODING-GAPS.md that aren't marked as resolved
          if [ -f "DOGFOODING-GAPS.md" ]; then
            GAPS=$(grep -c "^- \[ \]" DOGFOODING-GAPS.md || echo "0")
            echo "gap_count=$GAPS" >> $GITHUB_OUTPUT

            if [ "$GAPS" -gt 0 ]; then
              echo "has_gaps=true" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Found $GAPS unresolved dogfooding gaps"
            else
              echo "has_gaps=false" >> $GITHUB_OUTPUT
              echo "‚úÖ No unresolved dogfooding gaps"
            fi
          else
            echo "has_gaps=false" >> $GITHUB_OUTPUT
            echo "gap_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Check recent pattern additions
        id: check-patterns
        run: |
          # Check if any pattern files were modified in the last 7 days
          WEEK_AGO=$(date -d '7 days ago' +%Y-%m-%d 2>/dev/null || date -v-7d +%Y-%m-%d)

          RECENT_PATTERNS=$(find patterns/ -name "*.md" -type f -newermt "$WEEK_AGO" 2>/dev/null | wc -l || echo "0")

          echo "recent_count=$RECENT_PATTERNS" >> $GITHUB_OUTPUT

          if [ "$RECENT_PATTERNS" -gt 0 ]; then
            echo "has_recent=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è $RECENT_PATTERNS pattern(s) added/modified in last 7 days"
          else
            echo "has_recent=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No pattern changes in last 7 days"
          fi

      - name: Create self-compliance audit issue
        if: steps.check-gaps.outputs.has_gaps == 'true' || steps.check-patterns.outputs.has_recent == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toLocaleDateString('en-US', {
              month: 'long',
              day: 'numeric',
              year: 'numeric'
            });

            const gapCount = '${{ steps.check-gaps.outputs.gap_count }}';
            const recentPatterns = '${{ steps.check-patterns.outputs.recent_count }}';

            let body = 'Self-compliance audit for ' + date + '\n\n';
            if (gapCount > 0) body += '‚ö†Ô∏è **' + gapCount + ' unresolved dogfooding gap(s) in DOGFOODING-GAPS.md**\n';
            if (recentPatterns > 0) body += 'üìö **' + recentPatterns + ' pattern(s) added/modified this week**\n';
            body += '\n## Self-Compliance Checklist\n\n';
            body += '### Review Recent Pattern Additions\n';
            if (recentPatterns > 0) {
              body += '- [ ] Review ' + recentPatterns + ' pattern file(s) modified this week\n';
              body += '- [ ] Check if patterns apply to this repository\n';
              body += '- [ ] Implement patterns we should follow (dogfooding)\n';
              body += '- [ ] Update DOGFOODING-GAPS.md if not implementing\n';
            } else {
              body += '- [x] No recent pattern additions this week\n';
            }
            body += '\n### DOGFOODING-GAPS.md Review\n';
            if (gapCount > 0) {
              body += '- [ ] Review ' + gapCount + ' open gap(s)\n';
              body += '- [ ] Decide: implement or document why not?\n';
              body += '- [ ] Update gap status (resolved/deferred/justified)\n';
            } else {
              body += '- [x] No open dogfooding gaps\n';
            }
            body += '\n### Project Infrastructure Compliance\n' +
              '- [ ] Check .claude/ structure matches patterns/project-infrastructure.md\n' +
              '- [ ] Verify settings.json follows patterns/advanced-hooks.md\n' +
              '- [ ] Confirm skills follow skills/SKILL-TEMPLATE.md\n' +
              '- [ ] Validate CLAUDE.md matches templates/CLAUDE.md.template\n\n' +
              '### Documentation Consistency\n' +
              '- [ ] ARCHITECTURE.md reflects current directory structure\n' +
              '- [ ] SOURCES.md has all references properly tiered (A/B/C/D)\n' +
              '- [ ] Cross-references between patterns are bidirectional\n' +
              '- [ ] INDEX.md is up-to-date (run `python3 automation/generate_index.py`)\n\n' +
              '### Quality Standards\n' +
              '- [ ] All patterns have authoritative sources (Tier A or B)\n' +
              '- [ ] Pattern files include "Related Patterns" sections\n' +
              '- [ ] No broken internal links (checked by link-checker.yml)\n' +
              '- [ ] Markdown lint passes (`npm run lint`)\n\n' +
              '### Meta-Compliance\n' +
              '- [ ] This repository follows spec-driven development (SDD)\n' +
              '- [ ] Evidence tiers properly applied per SOURCES.md:1207-1232\n' +
              '- [ ] Contribution guidelines match actual practice (CONTRIBUTING.md)\n\n' +
              '---\n\n' +
              '**Self-Compliance Philosophy**: "Practice what we preach. If we document it, we should do it."\n\n' +
              '**Reference**: DOGFOODING-GAPS.md, PLAN.md:38\n\n' +
              '**Automatically created by source-monitoring workflow**';

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚úÖ Self-compliance audit - ' + date,
              labels: ['documentation', 'self-compliance'],
              body: body
            });

            console.log('Created issue #' + issue.data.number);

  documentation-maintenance:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Check if INDEX.md is stale
        id: check-index
        run: |
          # Check if any .md files are newer than INDEX.md
          if [ -f "INDEX.md" ]; then
            INDEX_TIME=$(stat -f %m INDEX.md 2>/dev/null || stat -c %Y INDEX.md)
            NEWEST_MD=$(find . -name "*.md" -not -path "./.git/*" -type f -exec stat -f %m {} \; 2>/dev/null | sort -n | tail -1 || echo "0")

            if [ "$NEWEST_MD" -gt "$INDEX_TIME" ]; then
              echo "stale=true" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è INDEX.md is stale"
            else
              echo "stale=false" >> $GITHUB_OUTPUT
              echo "‚úÖ INDEX.md is current"
            fi
          else
            echo "stale=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è INDEX.md missing"
          fi

      - name: Check PLAN.md for completed items
        id: check-plan
        run: |
          # Check if PLAN.md has completed items in "Completed This Cycle" section
          if grep -q "| Item | Completed | Notes |" PLAN.md; then
            COMPLETED_ITEMS=$(grep -A 100 "| Item | Completed | Notes |" PLAN.md | grep -c "| .* | .* 202[0-9] | .* |" || echo "0")

            if [ "$COMPLETED_ITEMS" -gt 3 ]; then
              echo "needs_archive=true" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è $COMPLETED_ITEMS items ready for archiving"
            else
              echo "needs_archive=false" >> $GITHUB_OUTPUT
              echo "‚úÖ Few items to archive"
            fi
          else
            echo "needs_archive=false" >> $GITHUB_OUTPUT
          fi

      - name: Create documentation maintenance issue
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toLocaleDateString('en-US', {
              month: 'long',
              day: 'numeric',
              year: 'numeric'
            });

            const indexStale = '${{ steps.check-index.outputs.stale }}' === 'true';
            const needsArchive = '${{ steps.check-plan.outputs.needs_archive }}' === 'true';

            let body = 'Daily documentation maintenance for ' + date + '\n\n';
            if (indexStale) body += '‚ö†Ô∏è **INDEX.md needs regeneration**\n';
            if (needsArchive) body += '‚ö†Ô∏è **PLAN.md has multiple completed items to archive**\n';
            body += '\n## Daily Maintenance Checklist\n\n';
            body += '### Generated Files\n';
            if (indexStale) {
              body += '- [ ] Run `python3 automation/generate_index.py`\n';
              body += '- [ ] Commit updated INDEX.md\n';
            } else {
              body += '- [x] INDEX.md is current\n';
            }
            body += '\n### PLAN.md Management\n';
            if (needsArchive) {
              body += '- [ ] Move completed items from PLAN.md to ARCHIVE.md\n';
              body += '- [ ] Update "Last Updated" date in PLAN.md\n';
              body += '- [ ] Clear "Completed This Cycle" section\n';
            } else {
              body += '- [ ] Review PLAN.md for any completed items\n';
            }
            body += '- [ ] Update review cadence "Next Review" dates\n' +
              '- [ ] Check if priorities need reordering\n\n' +
              '### ARCHIVE.md Updates\n' +
              '- [ ] Add week\'s completed items with dates\n' +
              '- [ ] Maintain chronological order (newest first)\n' +
              '- [ ] Preserve milestone markers\n\n' +
              '### Source Health Metrics\n' +
              '- [ ] Update PLAN.md with source check dates\n' +
              '- [ ] Note any sources that became stale (last checked >1 week ago)\n' +
              '- [ ] Document any new sources discovered\n\n' +
              '### Cross-Reference Integrity\n' +
              '- [ ] Check that new patterns reference related patterns\n' +
              '- [ ] Verify bidirectional links (if A links to B, B should link to A)\n' +
              '- [ ] Update README.md pattern list if new patterns added\n\n' +
              '### Date Freshness\n' +
              '- [ ] Update "Last Updated" in key files:\n' +
              '  - [ ] PLAN.md\n' +
              '  - [ ] SOURCES.md (if sources changed)\n' +
              '  - [ ] .github/workflows/README.md (if workflows changed)\n\n' +
              '### Issue Hygiene (check manually via GitHub)\n' +
              '- [ ] Review open issues - any stale (>30 days)?\n' +
              '- [ ] Check if automated issues were addressed and can be closed\n' +
              '- [ ] Apply labels to unlabeled issues\n' +
              '- [ ] Convert discussions to issues if actionable\n\n' +
              '### Quality Checks\n' +
              '- [ ] Run `npm run lint` - any new errors?\n' +
              '- [ ] Check workflow runs - any failing?\n' +
              '- [ ] Review recent commits - anything need follow-up?\n\n' +
              '---\n\n' +
              '**Documentation Maintenance Philosophy**: Keep the documentation alive. Stale docs are worse than no docs.\n\n' +
              '**Reference**: PLAN.md, ARCHITECTURE.md, documentation-maintenance.md pattern\n\n' +
              '**Automatically created by source-monitoring workflow**';

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üìä Documentation maintenance - ' + date,
              labels: ['documentation', 'maintenance'],
              body: body
            });

            console.log('Created issue #' + issue.data.number);

  community-engagement:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Check for open PRs
        id: check-prs
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            core.setOutput('pr_count', prs.data.length);
            core.setOutput('has_prs', prs.data.length > 0 ? 'true' : 'false');

            if (prs.data.length > 0) {
              console.log(`Found ${prs.data.length} open PR(s)`);
            }

            return prs.data.length;

      - name: Check for untriaged issues
        id: check-issues
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ''  // No labels = untriaged
            });

            // Filter out PRs (GitHub API includes them in issues)
            const actualIssues = issues.data.filter(issue => !issue.pull_request);
            const untriagedCount = actualIssues.filter(issue => issue.labels.length === 0).length;

            core.setOutput('untriaged_count', untriagedCount);
            core.setOutput('has_untriaged', untriagedCount > 0 ? 'true' : 'false');

            if (untriagedCount > 0) {
              console.log(`Found ${untriagedCount} untriaged issue(s)`);
            }

            return untriagedCount;

      - name: Create community engagement issue
        if: steps.check-prs.outputs.has_prs == 'true' || steps.check-issues.outputs.has_untriaged == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toLocaleDateString('en-US', {
              month: 'long',
              day: 'numeric',
              year: 'numeric'
            });

            const prCount = '${{ steps.check-prs.outputs.pr_count }}';
            const untriagedCount = '${{ steps.check-issues.outputs.untriaged_count }}';

            let body = 'Daily community engagement triage for ' + date + '\n\n';
            if (prCount > 0) body += 'üì¨ **' + prCount + ' open PR(s) need review**\n';
            if (untriagedCount > 0) body += 'üè∑Ô∏è **' + untriagedCount + ' issue(s) need triage**\n';
            body += '\n## Pull Request Review (' + prCount + ' open)\n\n';
            if (prCount > 0) {
              body += '### Review Process (CONTRIBUTING.md:201-222)\n\n' +
                '1. **Initial Triage** (24-48h target)\n' +
                '   - [ ] Check if PR aligns with contribution guidelines\n' +
                '   - [ ] Verify evidence tier is A or B (for new patterns)\n' +
                '   - [ ] Request clarifications if needed\n\n' +
                '2. **Technical Review** (3-7 days target)\n' +
                '   - [ ] Validate pattern against existing practices\n' +
                '   - [ ] Check for conflicts or redundancies\n' +
                '   - [ ] Verify production validation claims\n\n' +
                '3. **Integration Review**\n' +
                '   - [ ] Ensure cross-references are complete\n' +
                '   - [ ] Check SOURCES.md is updated\n' +
                '   - [ ] Verify self-compliance\n\n' +
                '4. **Decision**\n' +
                '   - [ ] Merge if approved\n' +
                '   - [ ] Request changes with specific guidance\n' +
                '   - [ ] Close if doesn\'t meet criteria (with explanation)\n';
            } else {
              body += '_No open PRs this week_\n';
            }
            body += '\n## Issue Triage (' + untriagedCount + ' untriaged)\n\n';
            if (untriagedCount > 0) {
              body += '### Triage Process\n\n' +
                'For each untriaged issue:\n\n' +
                '1. **Categorize**\n' +
                '   - [ ] Pattern proposal ‚Üí Label: `pattern-proposal`\n' +
                '   - [ ] Skill request ‚Üí Label: `skill-request`\n' +
                '   - [ ] Documentation issue ‚Üí Label: `documentation`\n' +
                '   - [ ] Bug ‚Üí Label: `bug`\n' +
                '   - [ ] Question ‚Üí Label: `question`\n\n' +
                '2. **Assess Priority**\n' +
                '   - [ ] Tier A source update ‚Üí Label: `tier-a`, `priority-high`\n' +
                '   - [ ] Community contribution ‚Üí Label: `community`\n' +
                '   - [ ] Enhancement ‚Üí Label: `enhancement`\n\n' +
                '3. **Next Action**\n' +
                '   - [ ] If pattern proposal: Request evidence tier and validation\n' +
                '   - [ ] If skill: Check universal applicability\n' +
                '   - [ ] If bug: Verify and reproduce\n' +
                '   - [ ] If question: Answer or convert to discussion\n\n' +
                '4. **Engage**\n' +
                '   - [ ] Thank contributor\n' +
                '   - [ ] Provide feedback within 48h\n' +
                '   - [ ] Set expectations for timeline\n';
            } else {
              body += '_All issues are properly labeled_\n';
            }
            body += '\n## General Community Health\n\n' +
              '### Active Discussions\n' +
              '- [ ] Check for unanswered questions in issue comments\n' +
              '- [ ] Follow up on stale threads\n' +
              '- [ ] Close issues resolved but not closed\n\n' +
              '### Contributor Recognition\n' +
              '- [ ] Thank contributors in PRs/issues\n' +
              '- [ ] Highlight good contributions in comments\n' +
              '- [ ] Update SOURCES.md with community contributions\n\n' +
              '### Documentation for Contributors\n' +
              '- [ ] Review CONTRIBUTING.md - still accurate?\n' +
              '- [ ] Check if common questions should be added to FAQ\n' +
              '- [ ] Update examples if contribution patterns change\n\n' +
              '---\n\n' +
              '**Community Engagement Philosophy**: Fast response time builds trust. Even "Thanks, reviewing" is valuable.\n\n' +
              '**Target Response Times**:\n' +
              '- Initial triage: 24-48h\n' +
              '- Technical review: 3-7 days\n' +
              '- Simple questions: Same day\n\n' +
              '**Automatically created by source-monitoring workflow**';

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ü§ù Community engagement triage - ' + date,
              labels: ['maintenance', 'community'],
              body: body
            });

            console.log('Created issue #' + issue.data.number);
