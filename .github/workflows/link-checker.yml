name: Link Checker

on:
  schedule:
    # Run every Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual triggering
  pull_request:
    paths:
      - '**.md'

jobs:
  check-links:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Check links in markdown files
        id: link-check
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          config-file: '.github/link-check-config.json'
          use-quiet-mode: 'no'
          use-verbose-mode: 'yes'
        continue-on-error: true

      - name: Get link check results
        if: steps.link-check.outcome == 'failure'
        id: results
        run: |
          echo "has_broken_links=true" >> $GITHUB_OUTPUT

      - name: Create issue for broken links
        if: steps.link-check.outcome == 'failure' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the link check output (it's in the logs, but we'll create a generic issue)
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîó Broken links detected in documentation',
              labels: ['documentation', 'bug'],
              body: `The weekly link checker has detected broken links in the documentation.

## Action Items
- [ ] Review the [workflow run logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details
- [ ] Fix broken links in affected files
- [ ] Update SOURCES.md if source URLs have changed
- [ ] Consider updating evidence tiers if sources are no longer accessible
- [ ] Check if archived/moved content needs alternative references

## Common Causes
- External websites moved or deleted content
- GitHub repositories renamed or archived
- Blog posts removed or URL structure changed
- Documentation sites restructured

## Fix Patterns
- Update URL to new location
- Use Internet Archive (web.archive.org) for historical references
- Mark source as ‚ö†Ô∏è Stale in SOURCES.md if no longer maintained
- Consider downgrading evidence tier if source quality declined

**Automatically created by link-checker workflow**

**Workflow run**: ${context.payload.repository.html_url}/actions/runs/${context.runId}`
            });

            console.log(`Created issue #${issue.data.number}`);

  markdown-lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run markdown lint
        run: npm run lint
        continue-on-error: true

      - name: Comment on PR if lint fails
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ‚ö†Ô∏è Markdown Lint Failed

Please fix markdown formatting issues:

\`\`\`bash
npm run lint:fix
\`\`\`

Then commit the fixes.

See the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`
            });

  check-source-accessibility:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Extract URLs from SOURCES.md
        id: extract-urls
        run: |
          # Extract all URLs from SOURCES.md
          grep -oP 'https?://[^\s)]+' SOURCES.md | sort -u > all_urls.txt

          echo "Extracted $(wc -l < all_urls.txt) unique URLs"

      - name: Check critical Tier A sources
        id: check-tier-a
        run: |
          # Critical Tier A sources that must be accessible
          TIER_A_SOURCES=(
            "https://www.anthropic.com/engineering"
            "https://github.com/anthropics/claude-code"
            "https://docs.anthropic.com"
            "https://agentskills.io"
            "https://github.com/github/spec-kit"
          )

          BROKEN_SOURCES=""

          for url in "${TIER_A_SOURCES[@]}"; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "$url" --max-time 10)

            if [ "$HTTP_CODE" -ge 400 ] || [ "$HTTP_CODE" -eq 000 ]; then
              echo "‚ùå CRITICAL: $url returned $HTTP_CODE"
              BROKEN_SOURCES="${BROKEN_SOURCES}- $url (HTTP $HTTP_CODE)\n"
            else
              echo "‚úÖ $url is accessible ($HTTP_CODE)"
            fi
          done

          if [ -n "$BROKEN_SOURCES" ]; then
            echo "has_broken_tier_a=true" >> $GITHUB_OUTPUT
            echo -e "$BROKEN_SOURCES" > broken_tier_a.txt
          else
            echo "has_broken_tier_a=false" >> $GITHUB_OUTPUT
          fi

      - name: Create critical issue for Tier A failures
        if: steps.check-tier-a.outputs.has_broken_tier_a == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const brokenSources = fs.readFileSync('broken_tier_a.txt', 'utf8');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® CRITICAL: Tier A sources inaccessible',
              labels: ['documentation', 'bug', 'critical', 'tier-a'],
              body: `## ‚ö†Ô∏è Critical Tier A Sources Are Inaccessible

The following primary sources (Evidence Tier A) are currently inaccessible:

${brokenSources}

## Impact
Tier A sources are **primary authoritative sources** including:
- Anthropic official documentation
- Industry standards (GitHub Spec Kit, agentskills.io)
- First-party production data

## Immediate Actions Required
- [ ] Verify if sources are temporarily down or permanently moved
- [ ] Check for official announcements about URL changes
- [ ] Update URLs if content moved to new location
- [ ] Use Internet Archive for historical content if removed
- [ ] Consider evidence tier implications if source unavailable

## Evidence Tier Implications
If a Tier A source is permanently unavailable:
1. Patterns based solely on that source may need tier downgrade
2. Alternative primary sources should be identified
3. SOURCES.md:1207-1232 should be updated

**This is a high-priority issue** - Tier A sources form the foundation of this repository.

**Automatically created by link-checker workflow**

**Workflow run**: ${context.payload.repository.html_url}/actions/runs/${context.runId}`
            });

            console.log(`Created critical issue #${issue.data.number}`);
